<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Transacciones</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #f0f0f0;
            --border-color: #444;
            --header-bg: #2a2a2a;
            --row-hover: #333;
            --link-color: #4a90e2;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 1em;
        }

        h1,
        h2 {
            color: var(--text-color);
            border-bottom: 2px solid var(--link-color);
            padding-bottom: 10px;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }

        th,
        td {
            border: 1px solid var(--border-color);
            padding: 12px 15px;
            text-align: left;
        }

        thead {
            background-color: var(--header-bg);
        }

        tbody tr:hover {
            background-color: var(--row-hover);
        }

        a {
            color: var(--link-color);
            text-decoration: none;
            cursor: pointer;
        }

        a:hover {
            text-decoration: underline;
        }

        .status-changeable {
            cursor: pointer;
            font-weight: bold;
        }

        .status-changeable:hover {
            text-decoration: underline;
            color: #ff9800;
        }

        #user-transactions-section {
            display: none;
            /* Oculto por defecto */
            margin-top: 2em;
        }

        @media screen and (max-width: 600px) {
            body {
                padding: 0.5em;
            }

            th,
            td {
                padding: 8px 5px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <section id="all-transactions-section">
            <h1>Todas las Transacciones</h1>
            <table>
                <thead>
                    <tr>
                        <th>ID Transacción</th>
                        <th>ID Usuario (Telegram)</th>
                        <th>Tipo</th>
                        <th>Monto USD</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="all-transactions-table-body"></tbody>
            </table>
        </section>

        <section id="user-transactions-section">
            <h2 id="user-transactions-title">Transacciones del Usuario</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID Transacción</th>
                        <th>Referencia</th>
                        <th>Tipo</th>
                        <th>Monto USD</th>
                        <th>Total BS</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="user-transactions-table-body"></tbody>
            </table>
        </section>
    </div>

    <script>
        // === Sistema de actualización automática ===

        // Guardamos los IDs de las transacciones ya mostradas
        let knownTransactionIds = new Set();

        // Llamamos esta función después de renderizar las transacciones
        function rememberTransactions(transactions) {
            transactions.forEach(t => knownTransactionIds.add(t.id));
        }

        // Sobrescribimos loadAllTransactions para registrar IDs
        async function loadAllTransactions() {
            allTransactionsSection.style.display = 'block';
            userTransactionsSection.style.display = 'none';

            const response = await fetch('http://62.169.27.35:3000/api/transactions');
            const transactions = await response.json();

            allTransactionsTableBody.innerHTML = ''; // Limpiar tabla

            // Registrar IDs conocidos
            rememberTransactions(transactions);

            const userGroups = {};
            transactions.forEach(t => {
                if (!userGroups[t.user_telegram_id]) {
                    userGroups[t.user_telegram_id] = [];
                }
                userGroups[t.user_telegram_id].push(t);
            });

            for (const userId in userGroups) {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.innerHTML = `
            <td>-</td>
            <td><a href="#" data-user-id="${userId}">${userId}</a></td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
        `;
                row.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadUserTransactions(userId);
                });
                allTransactionsTableBody.appendChild(row);
            }
        }

        // Sobrescribimos loadUserTransactions para registrar IDs
        async function loadUserTransactions(userId) {
            allTransactionsSection.style.display = 'none';
            userTransactionsSection.style.display = 'block';
            userTransactionsTitle.textContent = `Transacciones del Usuario: ${userId}`;

            const response = await fetch(`http://62.169.27.35:3000/api/transactions/${userId}`);
            const transactions = await response.json();

            rememberTransactions(transactions);
            renderUserTransactions(transactions);
        }

        // === NUEVA FUNCIÓN: Actualización periódica ===
        async function checkForNewTransactions() {
            try {
                const response = await fetch('http://62.169.27.35:3000/api/transactions');
                const transactions = await response.json();

                // Filtramos solo las nuevas
                const newOnes = transactions.filter(t => !knownTransactionIds.has(t.id));

                if (newOnes.length > 0) {
                    console.log("💡 Nuevas transacciones detectadas:", newOnes);

                    // Agregamos las nuevas al registro
                    rememberTransactions(newOnes);

                    // Si estamos en la vista general, recargamos todo
                    if (allTransactionsSection.style.display === 'block') {
                        loadAllTransactions();
                    } else {
                        // Si estamos en la vista de usuario, agregamos las nuevas
                        const currentUserId = userTransactionsTitle.textContent.split(': ')[1];
                        const newForUser = newOnes.filter(t => String(t.user_telegram_id) === currentUserId);
                        if (newForUser.length > 0) {
                            newForUser.forEach(t => {
                                const row = document.createElement('tr');
                                const statusCell = document.createElement('td');
                                statusCell.textContent = t.status;
                                if (t.status === 'Pendiente') {
                                    statusCell.classList.add('status-changeable');
                                    statusCell.title = 'Click para completar';
                                    statusCell.addEventListener('click', () => {
                                        updateTransactionStatus(t.id, 'Completada', t.user_telegram_id);
                                    });
                                }
                                row.innerHTML = `
                            <td>${t.id}</td>
                            <td>${t.payment_reference || '-'}</td>
                            <td>${t.transaction_type}</td>
                            <td>${t.amount_usd}</td>
                            <td>${t.total_bs || '-'}</td>
                        `;
                                row.appendChild(statusCell);
                                userTransactionsTableBody.prepend(row); // Agregar al inicio
                            });
                        }
                    }
                }
            } catch (error) {
                console.error("Error verificando nuevas transacciones:", error);
            }
        }

        // Iniciar chequeo automático cada 10 segundos
        setInterval(checkForNewTransactions, 10000);

    </script>
</body>

</html>