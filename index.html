<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Transacciones</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2em;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      tbody tr:hover {
        background-color: #f5f5f5;
      }
    </style>
  </head>
  <body>
    <h1>Todas las Transacciones</h1>
    <table>
      <thead>
        <tr>
          <th>ID Transacción</th>
          <th>ID Usuario (Telegram)</th>
          <th>Tipo</th>
          <th>Monto USD</th>
          <th>Referencia</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="transactions-table-body"></tbody>
    </table>

    <script>
      // Función para cargar todas las transacciones
      async function loadAllTransactions() {
        const response = await fetch("/api/transactions"); // Pedimos los datos al backend
        const transactions = await response.json();

        const tableBody = document.getElementById("transactions-table-body");
        tableBody.innerHTML = ""; // Limpiamos la tabla por si acaso

        // Recorremos cada transacción que nos llegó
        transactions.forEach((transaction) => {
          const row = document.createElement("tr");

          // ... idCell, typeCell, etc., se crean igual que antes ...
          const idCell = document.createElement("td");
          const userCell = document.createElement("td"); // Esta celda va a cambiar
          const typeCell = document.createElement("td");
          const amountCell = document.createElement("td");
          const statusCell = document.createElement("td");

          idCell.textContent = transaction.id;
          typeCell.textContent = transaction.transaction_type;
          amountCell.textContent = transaction.amount_usd;
          statusCell.textContent = transaction.status;

          // --- INICIO DE LA MODIFICACIÓN ---
          // 1. Creamos un elemento de enlace (<a>)
          const userLink = document.createElement("a");
          userLink.href = "#"; // El '#' evita que la página se recargue al hacer clic
          userLink.textContent = transaction.user_telegram_id; // Le ponemos el ID como texto

          // 2. Le añadimos un "escuchador de eventos" para el clic
          userLink.addEventListener("click", (event) => {
            // Detenemos el comportamiento normal del enlace
            event.preventDefault();

            // Llamamos a una nueva función para cargar los datos de este usuario
            loadUserTransactions(transaction.user_telegram_id);
          });

          // 3. Metemos el enlace (<a>) dentro de la celda (<td>)
          userCell.appendChild(userLink);
          // --- FIN DE LA MODIFICACIÓN ---

          // Añadimos las celdas a la fila, como antes
          row.appendChild(idCell);
          row.appendChild(userCell);
          row.appendChild(typeCell);
          row.appendChild(amountCell);
          row.appendChild(statusCell);

          tableBody.appendChild(row);
        });
      }

      async function loadUserTransactions(userId) {
        console.log(`Cargando transacciones para el usuario ${userId}...`);

        // 1. Construir la URL correcta para la API
        // ¿Qué URL deberíamos usar aquí para pedir los datos de 'userId'?
        const response = await fetch('/api/transactions/{userId}');
        const transactions = await response.json();

        // 2. Cambiar el título de la página para que sea más claro
        const pageTitle = document.querySelector("h1");
        pageTitle.textContent = `Transacciones del Usuario: ${userId}`;

        const tableBody = document.getElementById("transactions-table-body");
        tableBody.innerHTML = ""; // Limpiamos la tabla

        // 3. El código para rellenar la tabla es casi idéntico al de antes.
        // Lo podemos copiar y pegar aquí.
        transactions.forEach((transaction) => {
          // El código para crear las filas y celdas va aquí.
          // Es exactamente el mismo que usamos en `loadAllTransactions`.
          const row = document.createElement("tr");

          const idCell = document.createElement("td");
          const userCell = document.createElement("td");
          const typeCell = document.createElement("td");
          const amountCell = document.createElement("td");
          const statusCell = document.createElement("td");

          idCell.textContent = transaction.id;
          userCell.textContent = transaction.user_telegram_id; // Aquí no necesita ser un link
          typeCell.textContent = transaction.transaction_type;
          amountCell.textContent = transaction.amount_usd;
          statusCell.textContent = transaction.status;

          row.appendChild(idCell);
          row.appendChild(userCell);
          row.appendChild(typeCell);
          row.appendChild(amountCell);
          row.appendChild(statusCell);

          tableBody.appendChild(row);
        });
      }

      // Llamamos a la función cuando la página se carga
      loadAllTransactions();
    </script>
  </body>
</html>
